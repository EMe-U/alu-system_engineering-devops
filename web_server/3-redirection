#!/usr/bin/env bash
#
# This script installs Nginx and sets up a 301 redirection from /redirect_me

# Step 1: Update package list and install Nginx
apt update -y
apt install -y nginx

# Step 2: Remove any existing default Nginx configuration to avoid conflicts
rm -f /etc/nginx/sites-enabled/default
rm -f /etc/nginx/sites-available/default

# Step 3: Create a new Nginx configuration file for redirection
REDIRECT_CONF="/etc/nginx/sites-available/redirect_me"

cat > $REDIRECT_CONF << EOF
server {
    listen 80;
    server_name _;

    # Configure the redirection
    location = /redirect_me {
        return 301 https://www.youtube.com/watch?v=QH2-TGUlwu4;
    }

    # Catch-all location to avoid 404 for other paths
    location / {
        try_files \$uri \$uri/ =404;
    }
}
EOF

# Step 4: Enable the new configuration by creating a symbolic link
ln -sf /etc/nginx/sites-available/redirect_me /etc/nginx/sites-enabled/redirect_me

# Step 5: Test Nginx configuration for syntax errors
nginx -t

# Step 6: Restart Nginx to apply changes
service nginx restart

# Step 7: Wait a few seconds to ensure Nginx has fully reloaded
sleep 2

# Step 8: Test if the redirection works
REDIRECT_STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost/redirect_me)

# Step 9: Check if the status code is 301
if [ "$REDIRECT_STATUS" -eq 301 ]; then
    echo "Redirection configured successfully with status code: $REDIRECT_STATUS"
else
    echo "Error: Expected 301 but got $REDIRECT_STATUS"
    exit 1
fi
