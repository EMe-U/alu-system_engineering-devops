#!/usr/bin/env bash
#
# This script configures Nginx to set up a 301 redirection for /redirect_me

# Update the package list and install Nginx
sudo apt update -y
sudo apt install -y nginx

# Create a new Nginx configuration file for the redirection
REDIRECT_CONF="/etc/nginx/sites-available/redirect_me"

# Create the Nginx server block for redirection
sudo bash -c "cat > $REDIRECT_CONF" << EOF
server {
    listen 80;
    server_name _;

    location /redirect_me {
        return 301 https://www.youtube.com/watch?v=QH2-TGUlwu4;
    }
}
EOF

# Enable the new configuration by creating a symlink
sudo ln -sf /etc/nginx/sites-available/redirect_me /etc/nginx/sites-enabled/redirect_me

# Remove the default Nginx site configuration if it exists
sudo rm -f /etc/nginx/sites-enabled/default

# Test Nginx configuration for syntax errors
sudo nginx -t

# Restart Nginx to apply the new configuration
sudo systemctl restart nginx

# Ensure Nginx starts on boot
sudo systemctl enable nginx

# Confirm the redirection is set up correctly
REDIRECT_TEST=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/redirect_me)

# Check if the redirection is working correctly
if [ "$REDIRECT_TEST" -eq 301 ]; then
    echo "Redirection configured successfully with status code: 301"
else
    echo "Failed to set up redirection. Got status code: $REDIRECT_TEST"
fi
